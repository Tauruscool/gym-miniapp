const cloud = require('wx-server-sdk')

cloud.init({ env: cloud.DYNAMIC_CURRENT_ENV })

const db = cloud.database()

const _ = db.command

exports.main = async (event, context) => {
  const { OPENID } = cloud.getWXContext()

  const { q = '', status, startFrom, startTo } = event || {}

  // 1. 找到当前管理员所在租户
  const aRes = await db.collection('users')
    .where({ openid: OPENID })
    .field({ tenantId: true })
    .limit(1)
    .get()

  const tenantId = aRes.data?.[0]?.tenantId || 'default'

  // 2. 时间范围条件
  let startCond = null
  if (startFrom) startCond = _.gte(startFrom)
  if (startTo) {
    const toCond = _.lte(startTo)
    startCond = startCond ? _.and(startCond, toCond) : toCond
  }

  // 3. 关键字：匹配 title；同时模糊搜学员（手机号/昵称）
  const reg = q ? db.RegExp({ regexp: q, options: 'i' }) : null
  let userIdsByKeyword = []
  if (q) {
    const u = await db.collection('users')
      .where(_.and([
        { tenantId },
        _.or([{ phone: reg }, { nickname: reg }])
      ]))
      .field({ userId: true, _id: true })
      .limit(50)
      .get()
    userIdsByKeyword = (u.data || []).map(x => x.userId || x._id)
  }

  const base = {
    tenantId,
    ...(status ? { status } : {}),
    ...(startCond ? { startAt: startCond } : {})
  }

  const where = q
    ? _.and([
        base,
        _.or([
          { title: reg },
          { userId: _.in(userIdsByKeyword) }
        ])
      ])
    : base

  // 4. 查 sessions
  const sessRes = await db.collection('sessions')
    .where(where)
    .orderBy('startAt', 'asc')
    .field({
      _id: true,
      userId: true,
      title: true,
      startAt: true,
      endAt: true,
      status: true,
      coachId: true
    })
    .limit(100)
    .get()

  const sessions = sessRes.data || []

  // 5. 一次性查出所有涉及的用户手机号，避免循环查询
  const userIds = [...new Set(sessions.map(s => s.userId).filter(Boolean))]
  let phoneMap = {}
  if (userIds.length) {
    const usersRes = await db.collection('users')
      .where({ userId: _.in(userIds) })
      .field({ userId: true, phone: true })
      .get()
    phoneMap = {}
    ;(usersRes.data || []).forEach(u => {
      phoneMap[u.userId] = u.phone || ''
    })
  }

  // 6. 附加 userPhone 字段
  const list = sessions.map(s => ({
    ...s,
    userPhone: phoneMap[s.userId] || ''
  }))

  return { list }
}
