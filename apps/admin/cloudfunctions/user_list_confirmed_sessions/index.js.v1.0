const cloud = require('wx-server-sdk')

cloud.init({ env: cloud.DYNAMIC_CURRENT_ENV })

const db = cloud.database()

exports.main = async () => {
  const { OPENID } = cloud.getWXContext()

  // openid -> userId
  const u = await db.collection('users').where({ openid: OPENID }).field({ userId:true, tenantId:true }).limit(1).get()

  if (!u.data?.length) return { list: [] }

  const uid = u.data[0].userId || u.data[0]._id

  const tenantId = u.data[0].tenantId

  const where = { userId: uid, status: 'confirmed' }

  if (tenantId) where.tenantId = tenantId

  const { data } = await db.collection('sessions')
    .where(where)
    .orderBy('startAt', 'asc')
    .field({ _id:true, title:true, startAt:true, endAt:true, status:true, coachId:true })
    .limit(50).get()

  return { list: data || [] }
}

