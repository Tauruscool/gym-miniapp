const cloud = require('wx-server-sdk')

cloud.init({ env: cloud.DYNAMIC_CURRENT_ENV })

const db = cloud.database()

const _ = db.command

exports.main = async (event) => {
  const { OPENID } = cloud.getWXContext()

  const { page=1, pageSize=20, q='', createdFrom, createdTo } = event || {}

  const u = await db.collection('users').where({ openid: OPENID })
    .field({ userId:true, tenantId:true }).limit(1).get()

  if (!u.data?.length) return { list: [], total:0 }

  const uid = u.data[0].userId || u.data[0]._id

  const tenantId = u.data[0].tenantId

  let createdCond = null
  if (createdFrom) createdCond = _.gte(new Date(createdFrom).toISOString())
  if (createdTo)   createdCond = createdCond ? _.and(createdCond, _.lte(new Date(createdTo).toISOString()))
                                             : _.lte(new Date(createdTo).toISOString())

  const reg = q ? db.RegExp({ regexp: q, options:'i' }) : null

  const base = { userId: uid, ...(tenantId?{tenantId}:{}) , ...(createdCond?{ createdAt: createdCond }: {}) }

  const where = q ? _.and([ base, { comment: reg } ]) : base

  const coll = db.collection('training_reports')

  const total = (await coll.where(where).count()).total

  const { data } = await coll.where(where)
    .orderBy('createdAt','desc')
    .limit(pageSize).skip((page-1)*pageSize).get()

  return { list: data || [], total }
}
