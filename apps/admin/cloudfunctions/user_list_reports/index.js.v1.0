const cloud = require('wx-server-sdk')

cloud.init({ env: cloud.DYNAMIC_CURRENT_ENV })

const db = cloud.database()

exports.main = async (event) => {
  const { OPENID } = cloud.getWXContext()

  const { page=1, pageSize=20 } = event || {}

  const u = await db.collection('users').where({ openid: OPENID }).field({ userId:true, tenantId:true }).limit(1).get()

  if (!u.data?.length) return { list: [], total: 0 }

  const uid = u.data[0].userId || u.data[0]._id

  const tenantId = u.data[0].tenantId

  const where = { userId: uid }

  if (tenantId) where.tenantId = tenantId

  const coll = db.collection('training_reports')

  const total = (await coll.where(where).count()).total

  const { data } = await coll.where(where)
    .orderBy('createdAt','desc')
    .field({ _id:true, sessionId:true, RPE:true, comment:true, createdAt:true })
    .limit(pageSize).skip((page-1)*pageSize).get()

  return { list: data || [], total }
}

