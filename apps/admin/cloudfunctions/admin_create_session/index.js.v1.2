const cloud = require('wx-server-sdk')

cloud.init({ env: cloud.DYNAMIC_CURRENT_ENV })

const db = cloud.database()

const _ = db.command

exports.main = async (event, context) => {

  const { OPENID } = cloud.getWXContext()

  const { userId, coachId, startAt, endAt, title } = event || {}

  if (!userId) throw new Error('admin_create_session: 缺少 userId')

  if (!startAt || !endAt) throw new Error('admin_create_session: 缺少时间')

  // 1) 时间统一为 ISO

  const toISO = (t) => {

    const d = new Date(t)          // 兼容字符串/ISO

    if (isNaN(+d)) throw new Error('admin_create_session: 非法时间')

    return d.toISOString()

  }

  const sISO = toISO(startAt)

  const eISO = toISO(endAt)

  // 2) tenantId 推断链：参数 → 学员 → 管理员 → 默认

  let tenantId = event.tenantId || null

  if (!tenantId) {

    const uRes = await db.collection('users')

      .where(_.or([{ _id: userId }, { userId }]))

      .field({ tenantId: true })

      .limit(1).get()

    tenantId = uRes.data?.[0]?.tenantId || tenantId

  }

  if (!tenantId) {

    const aRes = await db.collection('users')

      .where({ openid: OPENID })

      .field({ tenantId: true })

      .limit(1).get()

    tenantId = aRes.data?.[0]?.tenantId || tenantId

  }

  if (!tenantId) {

    // MVP 兜底；如需严格多租户，改为 throw

    tenantId = 'default'

  }

  const doc = {

    userId,

    coachId: coachId || null,

    startAt: sISO,

    endAt: eISO,

    title: title || '未命名课程',

    status: 'pending',

    tenantId,

    createdAt: db.serverDate()

  }

  const { _id } = await db.collection('sessions').add({ data: doc })

  return { sessionId: _id }

}
