const defaultMuscles = ["全部", "下肢", "后链", "胸", "背", "核心"];

const statusFilters = ["全部", "待确认", "已确认", "已完成", "已取消"];

const statusMap = {
  'pending': '待确认',
  'confirmed': '已确认',
  'completed': '已完成',
  'cancelled': '已取消'
};

const statusFilterMap = {
  0: [], // 全部
  1: ['pending'],
  2: ['confirmed'],
  3: ['completed'],
  4: ['cancelled']
};

Page({

  data: {
    // 学员选择
    userQ: "",
    userResults: [],
    chosenUser: {},
    
    // 课程选择
    statusFilters: statusFilters,
    statusIdx: 0,
    onlyFuture: false,
    sessions: [],
    sessionId: "",
    
    // 报告填写
    deduct: 100,
    comment: "",
    RPE: 7,
    rpeOptions: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10],
    
    // 动作搜索
    key: "",
    muscles: defaultMuscles,
    muscleIdx: 0,
    page: 0,
    results: [],
    hasMore: false,
    
    // 已选动作
    selected: []
  },

  // 格式化时间
  fmt(timeStr) {
    if (!timeStr) return '';
    const d = new Date(timeStr);
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, '0');
    const day = String(d.getDate()).padStart(2, '0');
    const h = String(d.getHours()).padStart(2, '0');
    const min = String(d.getMinutes()).padStart(2, '0');
    return `${y}-${m}-${day} ${h}:${min}`;
  },

  // 状态文本
  statusText(status) {
    return statusMap[status] || status;
  },

  // A. 学员搜索
  onUserQ(e) {
    this.setData({ userQ: e.detail.value.trim() });
  },

  async searchUsers() {
    const q = this.data.userQ;
    if (!q) {
      wx.showToast({ icon: 'none', title: '请输入关键词' });
      return;
    }

    wx.showLoading({ title: '搜索中' });

    try {
      const res = await wx.cloud.callFunction({
        name: 'admin_search_users',
        data: { q, page: 0, pageSize: 20 }
      });

      const list = res.result?.list || [];
      this.setData({ userResults: list });

      if (!list.length) {
        wx.showToast({ icon: 'none', title: '未找到学员' });
      }
    } catch (err) {
      console.error(err);
      wx.showToast({ icon: 'none', title: (err.message || '搜索失败').slice(0, 17) });
    } finally {
      wx.hideLoading();
    }
  },

  pickUser(e) {
    const { id, name, phone } = e.currentTarget.dataset;
    this.setData({
      chosenUser: { userId: id, nickname: name, phone: phone || '' },
      userResults: [],
      sessions: [],
      sessionId: ''
    });
    // 自动加载课程列表
    this.loadSessions();
  },

  // B. 课程选择
  onStatusChange(e) {
    this.setData({ statusIdx: Number(e.detail.value), sessions: [], sessionId: '' });
    this.loadSessions();
  },

  toggleFuture(e) {
    this.setData({ onlyFuture: e.detail.value, sessions: [], sessionId: '' });
    this.loadSessions();
  },

  async loadSessions() {
    const { chosenUser, statusIdx, onlyFuture } = this.data;
    
    if (!chosenUser.userId) {
      wx.showToast({ icon: 'none', title: '请先选择学员' });
      return;
    }

    wx.showLoading({ title: '加载中' });

    try {
      const statusIn = statusFilterMap[statusIdx] || [];
      
      const res = await wx.cloud.callFunction({
        name: 'admin_list_sessions',
        data: {
          userId: chosenUser.userId,
          statusIn: statusIn.length ? statusIn : ['pending', 'confirmed', 'completed', 'cancelled'],
          onlyFuture,
          page: 0,
          pageSize: 50
        }
      });

      const list = res.result?.list || [];
      this.setData({ sessions: list });

      if (!list.length) {
        wx.showToast({ icon: 'none', title: '未找到课程' });
      }
    } catch (err) {
      console.error(err);
      wx.showToast({ icon: 'none', title: (err.message || '加载失败').slice(0, 17) });
    } finally {
      wx.hideLoading();
    }
  },

  pickSession(e) {
    const id = e.currentTarget.dataset.id;
    this.setData({ sessionId: id });
  },

  // C. 报告填写
  onDeduct(e) {
    this.setData({ deduct: Number(e.detail.value || 0) });
  },

  onComment(e) {
    this.setData({ comment: e.detail.value });
  },

  pickRPE(e) {
    const v = Number(e.currentTarget.dataset.v);
    this.setData({ RPE: v });
  },

  // D. 动作搜索
  onKey(e) {
    this.setData({ key: e.detail.value.trim() });
  },

  onMuscleChange(e) {
    this.setData({ muscleIdx: Number(e.detail.value), page: 0, results: [] });
    this._fetch(false);
  },

  async search() {
    this.setData({ page: 0, results: [] });
    await this._fetch(false);
  },

  _fetch(append) {
    wx.showLoading({ title: '搜索中' });

    const muscle = this.data.muscleIdx === 0 ? "" : this.data.muscles[this.data.muscleIdx];

    return wx.cloud.callFunction({
      name: 'catalog_search',
      data: { key: this.data.key, muscle, page: this.data.page, pageSize: 20 }
    }).then(r => {
      const list = r.result?.list || [];
      this.setData({
        results: append ? this.data.results.concat(list) : list,
        hasMore: !!r.result?.hasMore
      });
      if (!list.length) wx.showToast({ icon: 'none', title: '没有匹配的动作' });
    }).catch(err => {
      console.error(err);
      wx.showToast({ icon: 'none', title: (err.message || '搜索失败').slice(0, 17) });
    }).finally(() => wx.hideLoading());
  },

  // E. 动作管理
  addOne(e) {
    const code = e.currentTarget.dataset.code;
    const found = this.data.results.find(x => x.code === code);
    if (!found) return;

    if (this.data.selected.some(x => x.code === code)) {
      wx.showToast({ icon: 'none', title: '已在已选中' });
      return;
    }

    const item = {
      code: found.code,
      name: found.name,
      unit: found.unit,
      sets: 3,
      reps: found.unit === 'sec' ? 1 : 8,
      load: Number(found.defaultLoad || 0),
      notes: ''
    };

    this.setData({ selected: this.data.selected.concat(item) });
  },

  removeOne(e) {
    const code = e.currentTarget.dataset.code;
    this.setData({ selected: this.data.selected.filter(x => x.code !== code) });
  },

  editItem(e) {
    const code = e.currentTarget.dataset.code;
    const field = e.currentTarget.dataset.field;
    const valRaw = e.detail.value;
    const val = (field === 'notes') ? valRaw : Number(valRaw || 0);
    const arr = this.data.selected.map(x => x.code === code ? { ...x, [field]: val } : x);
    this.setData({ selected: arr });
  },

  // F. 提交
  submit() {
    const { sessionId, deduct, comment, RPE, selected } = this.data;

    if (!sessionId) {
      wx.showToast({ icon: 'none', title: '请选择课程' });
      return;
    }

    if (!selected.length) {
      wx.showToast({ icon: 'none', title: '请选择动作' });
      return;
    }

    if (deduct < 0) {
      wx.showToast({ icon: 'none', title: '扣费金额不合法' });
      return;
    }

    const report = { coachId: 'coach_001', items: selected, RPE, comment };

    wx.showLoading({ title: '提交中' });

    wx.cloud.callFunction({
      name: 'report_and_deduct',
      data: { sessionId, report, deductAmount: Number(deduct) }
    }).then(r => {
      wx.hideLoading();
      wx.showToast({ title: '已提交，余额' + r.result?.balance });
      // 清空
      this.setData({
        selected: [],
        comment: '',
        sessionId: '',
        chosenUser: {},
        sessions: [],
        userResults: []
      });
    }).catch(err => {
      console.error(err);
      wx.hideLoading();
      wx.showToast({ icon: 'none', title: (err.message || '提交失败').slice(0, 17) });
    });
  }

});
