const statusMap = {
  pending: '待确认',
  confirmed: '已确认',
  done: '已完成'
}

const fmtHM = iso => {
  if (!iso) return ''
  const d = new Date(iso)
  const h = String(d.getHours()).padStart(2, '0')
  const m = String(d.getMinutes()).padStart(2, '0')
  return `${h}:${m}`
}

// 返回某个日期的 "周一"
const getMonday = (d) => {
  const day = d.getDay() || 7 // 周日返回 0，我们改成 7
  const monday = new Date(d)
  monday.setDate(d.getDate() - day + 1)
  monday.setHours(0, 0, 0, 0)
  return monday
}

const formatDate = (d) => {
  const y = d.getFullYear()
  const m = String(d.getMonth() + 1).padStart(2, '0')
  const day = String(d.getDate()).padStart(2, '0')
  return `${y}-${m}-${day}`
}

// 根据配置生成 segments
function buildSegmentsForDay(sessions, timeConfig) {
  const { startHour, endHour, slotMinutes, segments } = timeConfig
  // 先把课程按"开始小时"归类
  const bucket = {} // key: hour -> [sessions]
  sessions.forEach(s => {
    const d = new Date(s.startAt)
    const hour = d.getHours()
    if (hour < startHour || hour >= endHour) return
    const key = String(hour)
    if (!bucket[key]) bucket[key] = []
    bucket[key].push(s)
  })
  const result = segments.map(seg => {
    const slots = []
    for (let h = seg.from; h < seg.to; h++) {
      const timeLabel = `${String(h).padStart(2, '0')}:00`
      const key = String(h)
      const list = (bucket[key] || []).map(it => ({
        ...it,
        startHM: fmtHM(it.startAt),
        endHM: fmtHM(it.endAt),
        statusText: statusMap[it.status] || it.status
      }))
      slots.push({
        time: timeLabel,
        hour: h,
        sessions: list
      })
    }
    return {
      key: seg.key,
      label: seg.label,
      slots
    }
  })
  return result
}

Page({
  data: {
    weekDays: [],      // 一周七天
    selectedDate: '',  // 当前选中的日期(YYYY-MM-DD)
    weekStart: '',     // 当前周一的日期
    statusTabs: [
      { value: 'all',      label: '全部' },
      { value: 'pending',  label: '待确认' },
      { value: 'confirmed',label: '已确认' },
      { value: 'done',     label: '已完成' }
    ],
    status: 'all',
    list: [],      // 原始课程列表（某一天）
    segments: [],  // 处理后的 "上午/下午/晚上 + 时间槽"
    loading: false,
    // 时间配置（现在写死，后面可以改成从数据库读）
    timeConfig: {
      startHour: 9,
      endHour: 21,
      slotMinutes: 60,
      segments: [
        { key: 'morning',   label: '上午',   from: 9,  to: 12 },
        { key: 'afternoon', label: '下午',   from: 12, to: 18 },
        { key: 'evening',   label: '晚上',   from: 18, to: 21 }
      ]
    }
  },
  onLoad() {
    const today = new Date()
    const monday = getMonday(today)
    this.buildWeek(monday, formatDate(today))
    this.refresh()
  },
  buildWeek(mondayDate, selected) {
    const todayStr = formatDate(new Date())
    const weekDays = []
    const labels = ['周一','周二','周三','周四','周五','周六','周日']
    for (let i = 0; i < 7; i++) {
      const d = new Date(mondayDate)
      d.setDate(mondayDate.getDate() + i)
      const dateStr = formatDate(d)
      weekDays.push({
        label: labels[i],
        day: String(d.getDate()).padStart(2, '0'),
        dateStr,
        isToday: dateStr === todayStr
      })
    }
    this.setData({
      weekDays,
      weekStart: formatDate(mondayDate),
      selectedDate: selected || weekDays[0].dateStr
    })
  },
  // 选择某天
  onPickDate(e) {
    const date = e.currentTarget.dataset.date
    this.setData({ selectedDate: date })
    this.refresh()
  },
  // 状态筛选
  onPickStatus(e) {
    const { value } = e.currentTarget.dataset
    this.setData({ status: value })
    this.refresh()
  },
  // 上一周
  prevWeek() {
    const monday = new Date(this.data.weekStart)
    monday.setDate(monday.getDate() - 7)
    this.buildWeek(monday, formatDate(monday)) // 默认选新周一
    this.refresh()
  },
  // 下一周
  nextWeek() {
    const monday = new Date(this.data.weekStart)
    monday.setDate(monday.getDate() + 7)
    this.buildWeek(monday, formatDate(monday))
    this.refresh()
  },
  async refresh() {
    const { selectedDate, status, timeConfig } = this.data
    if (!selectedDate) return

    this.setData({ loading: true })
    try {
      const { result } = await wx.cloud.callFunction({
        name: 'admin_list_all_sessions',
        data: {
          date: selectedDate,
          status
        }
      })

      const raw = (result && result.list) || []
      const segments = buildSegmentsForDay(raw, timeConfig)
      this.setData({
        list: raw,
        segments
      })
    } catch (err) {
      console.error('load all sessions error', err)
      wx.showToast({ title: '加载课程表失败', icon: 'none' })
    } finally {
      this.setData({ loading: false })
    }
  },
  goDetail(e) {
    const id = e.currentTarget.dataset.id
    if (!id) return
    wx.navigateTo({
      url: `/pages/sessions/detail/index?id=${id}`
    })
  }
})

